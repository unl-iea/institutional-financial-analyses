---
title: "IPEDS Financial Metrics"
subtitle: "NCES Data Files"
author: "Jason P. Casey"
date: 2020-04-05
output: 
  html_notebook:
    code_folding: show
params:
  year:
    label: "Last year of series"
    value: 2018
  unitid:
    label: "Reference Institution"
    value: "181464"
---

# Introduction

The following script estimates **College Stress Scores** as defined in _The College Stress Test: Tracking Institutional Futures across a Crowded Market_ by Robert Zemsky, Susan Shaman, and Susan Campbell Baldridge.  The IPEDS pieces are those recommended by the authors and estimations follow the guidelines in Appendix A of the book.

## Fields Used

File   | Field    | Description    | Notes
-------|----------|----------------|---------------------
HD     | unitid   | Unique identification number of the institution | 
HD     | instnm   | Institution (entity) name | 
HD     | city     | City location of institution |  
HD     | stabbr   | State abbreviation | 
HD     | fips     | FIPS state code | 
HD     | obereg   | Bureau of Economic Analysis (BEA) regions | _obereg < 9 _
HD     | opeflag  | OPE Title IV eligibility indicator code | _opeflag == 1_
HD     | control  | Control of institution | 
HD     | deggrant | Degree-granting status | _deggrant == 1_
HD     | longitud | Longitude location of institution | 
HD     | latitude | Latitude location of institution | 
HD     | iclevel  | Level of institution | _iclevel == 1_
IC     | ft_ug    | Full-time undergraduate students are enrolled | _ft_ug == 1_
IC     | distnced | All programs offered completely via distance education | _distnced == 0_
FLAGS  | prch_f   | Parent/child indicator- Finance | 
FLAGS  | idx_f    | ID number of parent institution - Finance | 
SFA    | igrnt_t  | Total amount of institutional grant aid awarded to full-time first-time undergraduates | _zero imputed for missing_
IC AY  | tuition2 | In-state average tuition for full-time undergraduates | 
IC AY  | tuition3 | Out-of-state average tuition for full-time undergraduates | 
EFA    | line     | Level of student (original line number on survey form) | 
EFA    | eftotlt  | Grand total | _(2008 and after)_
EFA    | efrace15 | Total men | _(prior to 2008)_
EFA    | efrace16 | Total women | _(prior to 2008)_
EFc    | line     | State of residence  (original line number on survey form) | _line not in (58, 99)_
EFc    | efres01  | First-time degree/certificate-seeking undergraduate students | _institutional mean imputed for missing odd years_
EFD    | ret_pcf  | Percent of first-time full-time degree/certificate-seeking undergraduate students in fall 2002 returning in fall 2003 | 
F1A    | f1b11    | State appropriations | 
F1A    | f1h02    | Value of endowment assets at the end of the fiscal year | 
F1A    | f1c191   | Total expenses-Total amount | 
F1A    | f1c121   | Hospital services-Total amount | 
F2     | f2d03    | State appropriations | 
F2     | f2h02    | Value of endowment assets at the end of the fiscal year | 
F2     | f2e131   | Total expenses-Total amount | 
F2     | f2e091   | Hospital services-Total amount | 


```{r setup}
# libraries
library(knitr)
library(lubridate)
library(broom)
library(tidyverse)
# set default document options
knitr::opts_chunk$set(fig.width = 8,
                      fig.asp = 0.618,
                      echo = TRUE,
                      warning = FALSE,
                      message = FALSE,
                      collapse = TRUE)
# set random seed
set.seed(1965)
# include user functions
source(file="user_functions.R")
```

# Read Data

## GDP Deflators

The Gross Domestic Product (GDP) deflators are available quarterly from the Federal Researve Bank of St. Louis in csv format. Zemsky, et al, used the fall (October) quarter _following_ the end of the fiscal cycle for each year.  Each _GDP_ score is divided by 100 to make them proper defaltors.

```{r}
system.time({
  gdp <-
    read_csv('https://fred.stlouisfed.org/graph/fredgraph.csv?id=GDPDEF',
             col_types = cols(.default = col_character())) %>%
    rename_all(tolower) %>%
    mutate(date = as_date(date),
           `Fiscal Year` = year(date),
           GDP = as.double(gdpdef) / 100) %>%
    filter(month(date) == 10) %>%
    select(`Fiscal Year`,
           GDP)
})
```

## Create Base Data Frame

Eight years of IPEDS data are pulled for each institution.  The fiscal years and indices (for projections) are defined in a base data frame.  The GDP data has been merged, since it has the same granualarity (one value per fiscal year).

```{r}
# base tibble
years <-
  tibble(`Fiscal Year` = seq(params$year - 7, params$year)) %>%
  mutate(Index = row_number()) %>%
  inner_join(gdp, by = c('Fiscal Year'))
rm(gdp)
```

## IPEDS Data

### Institutions

The authors limited their investigations to institutions that:
* have undergraduate enrollment
* are degree-granting
* are in the 50 states (and DC)
* are eligible to participate in Title IV financial aid

Additionally, this script limits the population to four-year institutions.  (Two year institutions will be examined separately).

```{r}
system.time({
  institutions <- 
    years %>%
    select(-GDP) %>%
    mutate(data = map(`Fiscal Year`, load_hd)) %>%
    unnest(cols = data)
  
  institutions <-
    institutions %>%
    group_by(unitid) %>%
    summarize(`Fiscal Year` = max(`Fiscal Year`)) %>%
    ungroup() %>%
    inner_join(institutions, by = c('unitid', 'Fiscal Year')) %>%
    filter(distance_ed == 0,
           obereg < 9,
           opeflag == '1',
           deggrant == '1',
           ft_ug == '1') %>%
    select(unitid,
           `Institution Name`,
           City,
           State,
           FIPS,
           Control,
           Closed,
           `Close Year`,
           Longitude,
           Latitude)
})
```

### Submission Flags

Because an institution's IPEDS Finance is often reported as part of a parent institution's record, the parent unitid was needed from the FLAGS file to roll up the non-financial metrics to match the financials.

```{r}
system.time({
  flags <-
    years %>%
    mutate(data = map(`Fiscal Year`, load_submissions)) %>%
    unnest(cols = data) %>%
    select(unitid, `Fiscal Year`, parent_id)
})
```

### Fall Enrollment (A)

First-time, first-year undergraduate enrollment was pulled from the EF-A.

```{r}
system.time({
  total_enrollment <-
    years %>%
    mutate(data = map(`Fiscal Year`, load_total_enrollment)) %>%
    unnest(cols = data) %>%
    select(unitid,
           `Fiscal Year`,
           `UG First-time First Year Enrollment`)
})
```

### Fall Enrollment (C)

State enrollments are used to adjust in/out of state tuition amounts and were pulled from EF-C.  The _line_ variable in EF-C matches state FIPS codes in the institutional header data.

```{r}
system.time({
  state_enrollment <-
    years %>%
    mutate(data = map(`Fiscal Year`, load_state_enrollment)) %>%
    unnest(cols = data) %>%
    inner_join(institutions, by = 'unitid') %>%
    mutate(`In State Enrollment` = ifelse(FIPS == line, efres01, 0),
           `Out of State Enrollment` = ifelse(!FIPS == line, efres01, 0)) %>%
    group_by(unitid, `Fiscal Year`) %>%
    summarize(first_years = sum(efres01, na.rm = TRUE),
              `In State Enrollment` = sum(`In State Enrollment`, na.rm = TRUE),
              `Out of State Enrollment` = sum(`Out of State Enrollment`, na.rm = TRUE))
})
```

### Retention (EF-D)

Retention is reported in EF-D as a whole number.  Here, it has been converted to a proportion by dividing by 100.

```{r}
system.time({
  retention <-
    years %>%
    mutate(data = map(`Fiscal Year`, load_retention)) %>%
    unnest(cols = data) %>%
    mutate(retention = as.numeric(ret_pcf) / 100)
  
  retention <-
    retention %>%
    group_by(unitid) %>%
    summarize(xretention = mean(retention, na.rm = TRUE)) %>%
    inner_join(retention, by = 'unitid') %>%
    mutate(retention = ifelse(is.na(retention), xretention, retention)) %>%
    select(unitid,
           `Fiscal Year`,
           retention)
})
```

### Academic Charges

In-state and Out-of-state charges were pulled from the academic year (AY) institutional characteristics (IC) file.  Amounts were deflated using the GDP deflator.

```{r}
system.time({
  charges <-
    years %>%
    mutate(data = map(`Fiscal Year`, load_charges)) %>%
    unnest(cols = data) %>%
    mutate(`In State Tuition` = as.double(tuition2) / GDP,
           `Out of State Tuition` = as.double(tuition3) / GDP) %>%
    select(unitid,
           `Fiscal Year`,
           `In State Tuition`,
           `Out of State Tuition`)
})
```

### Student Aid

Total institutional grant aid awarded to first-time, first-year undergraduates was pulled from the student financial aid (SFA) IPEDS component.  These values were deflated using the GDP deflator.

```{r}
system.time({
  aid <-
    years %>%
    mutate(data = map(`Fiscal Year`, load_sfa)) %>%
    unnest(cols = data) %>%
    mutate(`Inst Grant Aid` = as.double(igrnt_t) / GDP) %>%
    select(unitid,
           `Fiscal Year`,
           `Inst Grant Aid`)
})
```

### Finance (F2: FASB)

Private institutions and some publics use FASB accounting standards.  The relevant fields were pulled and deflated using the GDP deflator.

```{r}
system.time({
  finance <- 
    years %>%
    mutate(`Accounting Standard` = 'FASB',
           data = map(`Fiscal Year`, load_fasb)) %>%
    unnest(cols = data) %>%
    mutate(`Total Expenses` = as.double(`Total Expenses`) / GDP,
           `Hospital Expenses` = as.double(`Hospital Expenses`) / GDP,
           `Endowment EOY` = as.double(`Endowment EOY`) / GDP,
           `State Appropriations` = as.double(`State Appropriations`) / GDP) %>%
    select(unitid,
           Index,
           `Fiscal Year`,
           GDP,
           `Accounting Standard`,
           `State Appropriations`,
           `Total Expenses`,
           `Hospital Expenses`,
           `Endowment EOY`)
})
finance
```

### Finance (F1A: GASB)

Most public institutions use GASB accounting standards.  Needed values were pulled and deflated using the GDP deflator.

  retention <-
    retention %>%
    group_by(unitid) %>%
    summarize(xretention = mean(retention, na.rm = TRUE)) %>%
    inner_join(retention, by = 'unitid') %>%
    mutate(retention = ifelse(is.na(retention), xretention, retention)) %>%
    select(unitid,
           `Fiscal Year`,
           retention)

```{r}
system.time({
  finance <- 
    years %>%
    mutate(`Accounting Standard` = 'GASB',
           data = map(`Fiscal Year`, load_gasb)) %>%
    unnest(cols = data) %>%
    mutate(`Total Expenses` = as.double(`Total Expenses`) / GDP,
           `Hospital Expenses` = as.double(`Hospital Expenses`) / GDP, 
           `Endowment EOY` = as.double(`Endowment EOY`) / GDP,
           `State Appropriations` = as.double(`State Appropriations`) / GDP) %>%
    select(unitid,
           Index,
           `Fiscal Year`,
           GDP,
           `Accounting Standard`,
           `State Appropriations`,
           `Total Expenses`,
           `Hospital Expenses`,
           `Endowment EOY`) %>%
    bind_rows(finance)
  
  finance <-
    finance %>%
    group_by(unitid) %>%
    summarize(xappr = mean(`State Appropriations`, na.rm = TRUE),
              xtexp = mean(`Total Expenses`, na.rm = TRUE),
              xhexp = mean(`Hospital Expenses`, na.rm = TRUE),
              xedow = mean(`Endowment EOY`, na.rm = TRUE)) %>%
    inner_join(finance, by = 'unitid') %>%
    mutate(`Total Expenses` = ifelse(is.na(`Total Expenses`), xtexp, `Total Expenses`),
           `Hospital Expenses` = ifelse(is.na(`Hospital Expenses`), xhexp, `Hospital Expenses`), 
           `Endowment EOY` = ifelse(is.na(`Endowment EOY`), xedow, `Endowment EOY`),
           `State Appropriations` = ifelse(is.na(`State Appropriations`), xappr, `State Appropriations`)) %>%
    select(unitid,
           Index,
           `Fiscal Year`,
           GDP,
           `Accounting Standard`,
           `State Appropriations`,
           `Total Expenses`,
           `Hospital Expenses`,
           `Endowment EOY`)
})
```

# Create Metrics Files

## Create Base Metrics

Because EF-C is optional in odd-numbered years, there were a considerable number of missing values.  An institution's mean values were imputed for each missing year of counts for this section of the survey.  All non-financial metrics were aggregated at the parent institution's unitid and data were merged with the institutional header and financial data.  The basic metrics were computed as recommended in the book:

* Undergraduate First-time First-year Enrollment
* _Retention_ = Retention Rate
* _Endowment/Expenses_ = End-of-year Endowment / Total Expenses net of Hospital Expense
* _Market Price_ = In State Tuition times Proportion of In State Enrollment plus Out of State Tution time Proportion of Out of State Enrollment Less Institutional Grant Aid

```{r}
system.time({
  avg_is <-
    state_enrollment %>%
    group_by(unitid) %>%
    summarize(xfirst_years = mean(first_years, na.rm = TRUE),
              xin_state = mean(`In State Enrollment`, na.rm = TRUE),
              xout_state = mean(`Out of State Enrollment`, na.rm = TRUE))
  
  rollups <-
    total_enrollment %>%
    inner_join(charges, by = c('unitid', 'Fiscal Year')) %>%
    inner_join(aid, by = c('unitid', 'Fiscal Year')) %>%
    inner_join(retention, by = c('unitid', 'Fiscal Year')) %>%
    left_join(state_enrollment, by = c('unitid', 'Fiscal Year')) %>%
    inner_join(avg_is, by = 'unitid') %>%
    mutate(first_years = ifelse(is.na(first_years), xfirst_years, first_years),
           `In State Enrollment` = ifelse(is.na(`In State Enrollment`), xin_state, `In State Enrollment`),
           `Out of State Enrollment` = ifelse(is.na(`Out of State Enrollment`), xout_state, `Out of State Enrollment`)) %>%
    inner_join(flags, ., by = c('unitid', 'Fiscal Year')) %>%
    group_by(parent_id, `Fiscal Year`) %>%
    summarize(`UG First-time First Year Enrollment` = sum(`UG First-time First Year Enrollment`, na.rm = TRUE),
              `In State Enrollment` = sum(`In State Enrollment`, na.rm = TRUE) / sum(first_years, na.rm = TRUE),
              `Out of State Enrollment` = sum(`Out of State Enrollment`, na.rm = TRUE) / sum(first_years, na.rm = TRUE),
              Retention = mean(retention, na.rm = TRUE),
              `Inst Grant Aid` = sum(`Inst Grant Aid`, na.rm = TRUE),
              `In State Tuition` = mean(`In State Tuition`, na.rm = TRUE),
              `Out of State Tuition` = mean(`Out of State Tuition`, na.rm = TRUE)) %>%
    ungroup() %>%
    rename(unitid = parent_id)
  
  metrics <-
    institutions %>%
    inner_join(finance, by = c('unitid')) %>%
    inner_join(rollups, by = c('unitid', 'Fiscal Year')) %>%
    add_count(unitid) %>%
    filter(n == 8) %>%
    mutate(`Endowment/Expenses` = `Endowment EOY` / (`Total Expenses` - `Hospital Expenses`),
           `Average Grant Aid` = `Inst Grant Aid` / `UG First-time First Year Enrollment`,
           `Market Price` = (`In State Tuition` * `In State Enrollment` + `Out of State Tuition` * `Out of State Enrollment`) - `Average Grant Aid`) %>%
    rename(Unitid = unitid)
  
  rm(institutions,
     finance,
     charges,
     aid,
     total_enrollment,
     state_enrollment,
     flags,
     retention,
     avg_is,
     rollups,
     years)
})
```

## Output Metrics File

```{r}
system.time({
  metrics %>%
    write_csv('data/metrics.csv',
              na = '')
})
```

## Estimate Institutional Extrapolation Models

The authors create a linear function for each institution and use this to project three years past the most recent year.

```{r}
metrics <-
  read_csv('data/metrics.csv')
system.time({
  coef_helper <- function(td) as_tibble(t(deframe(td)))
  models <-
    metrics %>%
    select(Unitid,
           Control,
           Index,
           `UG First-time First Year Enrollment`,
           Retention,
           `State Appropriations`,
           `Endowment/Expenses`,
           `Market Price`) %>%
    drop_na() %>%
    pivot_longer(cols = 4:8,
                 names_to = 'Metric',
                 values_to = 'Value') %>%
    group_by(Unitid, Control, Metric) %>%
    nest() %>%
    mutate(model = map2('Value ~ Index', data, run_model),
           td = map(model, tidy),
           coef = map(td, coef_helper))
})
```

## Project Future Values

Using the estimated coefficients, project the value three years from the most recent year.

```{r}
system.time({
  projections <-
    models %>%
    select(Unitid,
           Control,
           Metric,
           coef) %>%
    unnest(cols = coef) %>%
    rename(Slope = Index) %>%
    mutate(Index = 11,
           Value = `(Intercept)` + Slope * Index) %>%
    select(Unitid,
           Control,
           Index,
           Metric,
           Value) %>%
    pivot_wider(names_from = Metric,
                values_from = Value)
})
```

## Compute Stress Scores

Change rates from the base year to the most recent year were calculated for four metrics for each institution type.

**Publics**

* Undergradaute First-time First-year Enrollment
* First-year to Second-year Retention Rate
* State Appropriations (in Constant Dollars)
* Market Price (in Constant Dollars)

**Privates**

* Undergradaute First-time First-year Enrollment
* First-year to Second-year Retention Rate
* Endowment/Expenses (in Constant Dollars)
* Market Price (in Constant Dollars)

These were compared to benchmarks established by the authors to set statuses of _Alert_ and _Warning_ (consistent with National Weather Service terminology) for each of the four core metrics.  These Alert and Warning Scores were summed to produce the final _Stress Score_.

_Notes_
* The assumption that increases in _Retention_ of 56% - 68% are possible is implausible.  This was either due to a misprint, or a basic misuse of the statistic.  Highly selective institutions with return rates in the 90% range are getting Alerts and Warnings on this statistic because their increases fall below 65.6% and 56.4%, respectively.  A more commonsense approach might be to alert those with declining retention rates, and warn those with declines of larger than some criterion such as, say, 5% or 10%.
* It is unclear whether the relationship between _Undergraduate First-time First-year Enrollment_ and _Market Price_ is fully accounted for in the authors' model.  Does a decrease in realized tuition reflect poor financial health if enrollments are increasing?  Similarly, increased tuition my not reflect strenth if enrollments are falling.
* Many institutions that have publicly acknowledged financial struggles do not seem to have correspondingly high stress scores.
* Missing values are hard to account for in the calculation of metrics and stress scores.  Non-random patterns of missing data might undermine this model for measuring risk.

```{r}
system.time({
  criteria <-
    tribble(~Metric, ~Control, ~Crit1, ~Crit2,
            'UG First-time First Year Enrollment', 'Public', -0.154, -0.256,
            'Retention', 'Public', 0.68, 0.62,
            'Endowment/Expenses', 'Public', 0, -0.103,
            'State Appropriations', 'Public', -0.27, -0.37,
            'Market Price', 'Public', 0, -0.083,
            'UG First-time First Year Enrollment', 'Private', 0.174, 0.308,
            'Retention', 'Private', 0.656, 0.564,
            'Endowment/Expenses', 'Private', 0, -0.103,
            'State Appropriations', 'Private', -0.27, -0.37,
            'Market Price', 'Private', -0.104,  -0.175)
  
  institution_header <-
    metrics %>%
    distinct(Unitid,
             `Institution Name`,
             City,
             State,
             FIPS,
             Control,
             `Accounting Standard`,
             Closed,
             `Close Year`,
             Longitude,
             Latitude)
  
  stress_scores <-
    metrics %>%
    select(Unitid,
           Control,
           Index, 
           `UG First-time First Year Enrollment`,
           Retention,
           `State Appropriations`,
           `Endowment/Expenses`,
           `Market Price`) %>%
    bind_rows(projections) %>%
    pivot_longer(cols = 4:8,
                 names_to = 'Metric',
                 values_to = 'Value') %>%
    arrange(Unitid, Control, Metric, Index) %>%
    group_by(Unitid, Control, Metric) %>%
    mutate(Change = ifelse(Index == 8, (Value - lag(Value, 7)) / lag(Value, 7), (Value - lag(Value, 8)) / lag(Value, 8))) %>%
    ungroup() %>%
    drop_na()
  
  stress_scores <-
    stress_scores %>%
    count(Unitid, Control, Metric) %>%
    inner_join(stress_scores) %>%
    filter(n == 2) %>%
    inner_join(criteria) %>%
    mutate(Alert = ifelse(Change <= Crit1, 1, 0),
           Warning = ifelse(Change <= Crit2 & Index == 8, 1, 0)) %>%
    select(-n, -Value, -Crit1, -Crit2)
  
  stress_scores <-
    stress_scores %>%
    pivot_longer(cols = 6:7,
                 names_to = 'Status',
                 values_to = 'Value') %>%
    mutate(Value = ifelse(Control == 'Public' & Metric == 'Endowment/Expenses', 0, Value),
           Value = ifelse(Control == 'Private' & Metric == 'State Appropriations', 0, Value)) %>%
    group_by(Unitid) %>%
    summarize(`Stress Score` = sum(Value)) %>%
    ungroup() %>%
    mutate(`Stress Score Pct` = `Stress Score` / 12) %>%
    inner_join(stress_scores, ., by = 'Unitid') %>%
    mutate(Type = recode(Index,
                         `8` = 'Actual',
                         `11` = 'Projected')) %>%
    select(-Index) %>%
    pivot_wider(names_from = c(Metric, Type),
                values_from = c(Change, Alert, Warning)) %>%
    inner_join(institution_header, ., by = c('Unitid', 'Control'))
})
```

## Output Stress Scores File

```{r}
system.time({
  stress_scores %>%
    write_csv('data/stress.csv',
              na = '')
})
```

```{r}
stress_scores %>%
  filter(Unitid == 181464)
```

# Plots

## Endowment/Expenses vs Market Price

```{r}
metrics %>%
  ggplot(aes(x = `Endowment/Expenses`, y = `Market Price`)) +
    geom_hex(bins = 40)
```

## State Appropriations vs Market Price

```{r}
metrics %>%
  ggplot(aes(x = `State Appropriations`, y = `Market Price`)) +
    geom_hex(bins = 40)
```

# References

## Book

Zemsky, R., Shaman, S., Campbell Baldridge, S. (2020). _The College Stress Test: Tracking Institutional Futures across a Crowded Market_. Johns Hopkins University Press.  Baltimore, Maryland.

## Software

```{r}
citation('base')
citation('knitr')
citation('lubridate')
citation('broom')
citation('tidyverse')
```

Built with R version `r getRversion()`.
