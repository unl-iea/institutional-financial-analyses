---
title: "IPEDS Financial Metrics"
subtitle: "NCES Data Files"
author: "Jason P. Casey"
date: 2020-04-03
output: 
  html_notebook:
    code_folding: show
---

```{r setup}
# libraries
library(lubridate)
library(broom)
library(tidyverse)
library(data.table)

# set default document options
knitr::opts_chunk$set(fig.width = 6,
                      fig.asp = 0.618,
                      fig.retina = 2,
                      out.width = "70%",
                      fig.align = "center",
                      echo = TRUE,
                      warning = FALSE,
                      message = FALSE,
                      collapse = TRUE)

# set random seed
set.seed(1965)

# EF headcount FTE weights
# see 'Calculation of FTE students (using fall student heacounts) in
#    https://surveys.nces.ed.gov/ipeds/VisGlossaryAll.aspx
weights <- data.table(time_status = rep(c('Full-time', 'Part-time'),
                                        times = 1, each = 24),
                      career_level = rep(c('Undergraduate', 'Graduate'),
                                         times = 6, each = 4),
                      Control = rep(c('Public', 'Private', 'For-profit'),
                                    times = 2, each = 8),
                      Level = c(1, 2, 3, -3),
                      weight = c(rep(1, 24),
                                 c(0.403543, 0.335737, 0.335737, 0.382059,
                                   0.361702, 0.335737, 0.335737, 0.335737,
                                   0.392857, 0.335737, 0.335737, 0.335737,
                                   0.382059, 0.335737, 0.335737, 0.335737,
                                   0.392857, 0.335737, 0.335737, 0.335737,
                                   0.382059, 0.335737, 0.335737, 0.335737))
                      )

# set constants
last_year <- ifelse(month(today()) > 9,
                      year(today()) - 1,
                      year(today()) - 2)

# base tibble used for all data pulls
years <- data.table(year_key = seq(last_year - 10, last_year))
years[, `Fiscal Year` := paste(year_key - 1, year_key, sep = '-')]
```

# Read Data

### Institutions

```{r}
ic <- readRDS('data/characteristics.rds')[distnced == 0 & ft_ug == 1,
                                          .(unitid, year_key)]

institutions <- readRDS('data/directory.rds')[level_institution == 1 &
                                                bea_region < 9 &
                                                title4_eligible == 1 &
                                                degree_granting == 1 &
                                                control %in% 1:2]

institutions <- institutions[year_key == max(year_key), by = unitid]

institutions <- merge.data.table(
  x = institutions,
  y = ic,
  by = c('unitid', 'year_key')
  )

rm(ic)

institutions <- institutions[
  ,
  .(unitid,
    `Institution Name` = institution_name,
    City = city,
    State = state,
    FIPS = fips,
    Level = level_institution,
    Control = recode(control,
                     `1` = 'Public',
                     `2` = 'Private'),
    Closed = ifelse(is.na(close_year), 0, 1),
    `Close Year` = ifelse(close_year > 0, close_year, NA),
    `Close Date` = as_date(close_date, tz = 'UTC', format = '%m/%d/%Y'),
    Longitude = longitude,
    Latitude = latitude)]

institutions        
```

## Year Labels

Assigns fiscal and calendar years, aligning the collection cycles for IPEDS Data.

```{r}
years <- readRDS('data/ipeds_years.rds')[
  year_key >= params$year,
  .(year_key,
    fiscal_year,
    academic_year,
    calendar_year_fall)
  ]

years
```

### Fall Enrollment

```{r}
submissions <- merge.data.table(
  x = readRDS('data/submissions.rds'),
  y = years[, .(year_key)],
  by = 'year_key')

submissions <- submissions[
  ,
  .(unitid,
    year_key,
    parent_id = ifelse(prch_f %in% c('1', '2', '3'), idx_f, unitid))]

total_enrollment <- merge.data.table(
  x = readRDS('data/fall_enrollment.rds')[year_key >= params$year],
  y = submissions,
  by = c('unitid', 'year_key')
  )

total_enrollment <- total_enrollment[
  ,
  .(headcount = sum(headcount, na.rm = T)),
  by = .(unitid = parent_id, year_key, time_status, career_level)]

total_enrollment
```

### Financial Aid

```{r}
student_financial_aid <- merge.data.table(
  x = readRDS('data/student_financial_aid.rds')[field == 'igrnt_t'],
  y = years[, .(year_key)],
  by = 'year_key')

student_financial_aid <- merge.data.table(
  x = student_financial_aid,
  y = submissions,
  by = c('unitid', 'year_key')
  )

student_financial_aid <- student_financial_aid[
  ,
  .(`Inst Grant Aid` = sum(value, na.rm = TRUE)),
  by = .(unitid = parent_id, year_key)]

rm(submissions)

student_financial_aid
```

### F1A and F2 Financial Data

```{r}
finance <- merge.data.table(
  x = readRDS('data/finance.rds')[year_key >= params$year],
  y = readRDS('data/gdp.rds')[year_key >= params$year & month == 4,
                              .(year_key, gdp)],
  by = 'year_key')

finance <- finance[field %in% c('f2b01', 'f2b02', 'f2d01', 'f2a03a', 'f2a17',
                                'f2a18', 'f2c05', 'f2c06', 'f2c08', 'f2c10',
                                'f2d01', 'f2e135', 'f2h02',
                                'f1d01', 'f1d02', 'f1a07', 'f1a27t4',
                                'f1a284', 'f1e05', 'f1e06', 'f1e08', 'f1e10',
                                'f1b01', 'f1c19dp', 'f1h02', 'f1b09')]

finance[, amount := fcoalesce(amount, 0)]
finance[, amount := amount / gdp]
finance[, field := recode(field,
                          'f2b01' = 'Total Revenues',
                          'f2b02' = 'Total Expenses',
                          'f2a03a' = 'Total Debt',
                          'f2a17' = 'Total Plant',
                          'f2a18' = 'Accumulated Depreciation',
                          'f2c05' = 'Institutional Grants (Funded)',
                          'f2c06' = 'Institutional Grants (Unfunded)',
                          'f2c08' = 'Allowances to Tuition and Fees',
                          'f2c10' = 'Total Discounts',
                          'f2d01' = 'Tuition Revenue',
                          'f2e135' = 'Depreciation Expense',
                          'f2h02' = 'Endowment EOY',
                          'f1d01' = 'Total Revenues',
                          'f1d02' = 'Total Expenses',
                          'f1a07' = 'Total Debt',
                          'f1a27t4' = 'Total Plant',
                          'f1a284' = 'Accumulated Depreciation',
                          'f1e05' = 'Institutional Grants (Funded)',
                          'f1e06' = 'Institutional Grants (Unfunded)',
                          'f1e08' = 'Allowances to Tuition and Fees',
                          'f1e10' = 'Total Discounts',
                          'f1b01' = 'Tuition Revenue',
                          'f1c19dp' = 'Depreciation Expense',
                          'f1h02' = 'Endowment EOY')]
finance <- dcast(
  finance,
  unitid + year_key + accounting_standard ~ field,
  value.var = 'amount')

# gasb <- finance[
#   accounting_standard == 'GASB',
#   .(unitid,
#     year_key,
#     accounting_standard,
#     `Total Revenues` = f1b09,
#     `Total Expenses` = f1d02,
#     `Total Debt` = f1a07,
#     `Total Plant` = f1a27t4,
#     `Accumulated Depreciation` = f1a284,
#     `Institutional Grants (Funded)` = f1e05,
#     `Institutional Grants (Unfunded)` = f1e06,
#     `Allowances to Tuition and Fees` = f1e08,
#     `Total Discounts` = f1e10,
#     `Tuition Revenue` = f1b01,
#     `Depreciation Expense` = f1c19dp,
#     `Endowment EOY` = f1h02)]
# 
# fasb <- finance[
#   accounting_standard == 'FASB',
#   .(unitid,
#     year_key,
#     accounting_standard,
#     `Total Revenues` = f2b01,
#     `Total Expenses` = f2b02,
#     `Total Debt` = f2a03a,
#     `Total Plant` = f2a17,
#     `Accumulated Depreciation` = f2a18,
#     `Institutional Grants (Funded)` = f2c05,
#     `Institutional Grants (Unfunded)` = f2c06,
#     `Allowances to Tuition and Fees` = f2c08,
#     `Total Discounts` = f2c10,
#     `Tuition Revenue` = f2d01,
#     `Depreciation Expense` = f2e135,
#     `Endowment EOY` = f2h02)]

# finance <- funion(gasb, fasb)

finance[unitid == 181464]
```

## Estimate FTE from Fall Enrollment Counts

```{r}
setkey(institutions, unitid)
setkey(total_enrollment, unitid)
fte <- total_enrollment[institutions, nomatch = NULL]

setkey(weights, time_status, career_level, Control, Level)
setkey(fte, time_status, career_level, Control, Level)
fte <- weights[fte, nomatch = NULL]

fte[, fte := headcount * weight]

fte <- fte[
  ,
  .(Headcount = sum(headcount, na.rm = TRUE),
    FTE = sum(fte, na.rm = TRUE)),
  by = .(unitid, year_key, career_level)]

fte <- dcast(
  fte,
  unitid + year_key ~ career_level,
  value.var = c('Headcount', 'FTE'),
  fill = 0)

fte[, `:=`(`Total FTE` = FTE_Undergraduate + FTE_Graduate,
           `Total Headcount` = Headcount_Undergraduate + Headcount_Graduate)]

rm(total_enrollment, weights)
fte
```

# Merge Files and Write Data File

```{r}
setkey(fte, unitid)
metrics <- institutions[fte, nomatch = NULL]

setkey(metrics, unitid, year_key)
setkey(finance, unitid, year_key)
metrics <- metrics[finance, nomatch = NULL]

setkey(metrics, year_key)
setkey(years, year_key)
metrics <- metrics[years, nomatch = NULL]

metrics <- rename(metrics,
                  Unitid = unitid,
                  `Fiscal Year` = fiscal_year,
                  `Academic Year` = academic_year,
                  `Calendar Year (Fall)` = calendar_year_fall)

metrics <- metrics[
  ,
  `:=`(Margin = `Total Revenues` - `Total Expenses`,
       `Margin per FTE (000)` = (`Total Revenues` - `Total Expenses`) / 1000 / `Total FTE`,
       `Gross tuition` = `Tuition Revenue` + `Allowances to Tuition and Fees`,
       `Tuition dependence` = `Tuition Revenue` / `Total Revenues`,
       `Discount rate` = `Allowances to Tuition and Fees` / (`Tuition Revenue` + `Allowances to Tuition and Fees`),
       `Percentage of Grants from Unfunded Sources` = `Institutional Grants (Unfunded)` / `Total Discounts`,
       `Age of Plant` = `Accumulated Depreciation` / `Depreciation Expense`)
  ]

metrics |>
  write_csv('data/ipeds_metrics.csv',
            na = '')
saveRDS(metrics, 'data/ipeds_metrics.rds')
metrics
```

# Plotting Examples

## Bar Plot

```{r}
metrics |>
  filter(`Fiscal Year` == '2020-2021',
         Unitid %in% c('181464',
                       '181215',
                       '181020',
                       '181002',
                       '181394',
                       '181783',
                       '181446',
                       '181738',
                       '181428')) |>
  mutate(`Institution Name` = fct_reorder(`Institution Name`, `Tuition dependence`)) |>
  ggplot(aes(x = `Tuition dependence`,
             y = `Institution Name`,
             fill = Control)) +
    geom_col(alpha = 0.8) +
    scale_x_continuous(labels = scales::label_percent(),
                       limits = c(0,1)) +
    scale_fill_manual(values = c('darkgray', '#fc8d59')) +
    labs(title = 'Tuition Dependence at Selected Institutions',
         subtitle = 'FY2020-21',
         y = NULL)

```

## Scatter Plot of Tuition Revenue and Tuition Dependence

```{r}
metrics |>
  filter(`Fiscal Year` == '2020-2021',
         Control %in% c('Private', 'Public'),
         !is.na(Margin)) |>
  mutate(`Margin Category` = ifelse(Margin < 0, 'Loss', 'Even'),
         `Margin Category` = ifelse(Margin > 0, 'Gain', `Margin Category`),
         `Institutional Grants (Unfunded)` = `Institutional Grants (Unfunded)` / `Total FTE`) |>
  ggplot(aes(x = `Tuition dependence`,
             y = `Institutional Grants (Unfunded)`,
             color = `Margin Category`)) +
  geom_point(alpha = 0.5) +
  scale_x_continuous(labels = scales::label_percent(),
                     limits = c(0, 1)) +
  scale_y_continuous(breaks = scales::breaks_extended(8),
                     labels = scales::label_dollar(scale = .001,
                                                   suffix = 'K')) +
  scale_color_manual(values = c('#636363', '#91bfdb', '#fc8d59')) +
  labs(title = 'Average Unfunded Grant vs. Tuition Dependence',
       subtitle = 'Public and Private U.S. Institutions, FY2020-21')
```

## Heatmap

```{r}
metrics |>
  filter(`Fiscal Year` == '2020-2021',
         State == 'NE') |>
  mutate(`Revenues per FTE` = `Total Revenues` / `Total FTE`,
         `Tuition per FTE` = `Tuition Revenue` / `Total FTE`,
         `Discount per FTE` = `Total Discounts` / `Total FTE`,
         `Discount per FTE` = max(`Discount per FTE`) - `Discount per FTE`,
         `Average Unfunded Grant` = `Institutional Grants (Unfunded)` / `Total FTE`,
         `Endowment per FTE` = `Endowment EOY` / `Total FTE`,
         `Tuition dependence` = 1 - `Tuition dependence`) |>
  select(`Institution Name`,
         Control,
         `Revenues per FTE`,
         `Tuition per FTE`,
         `Discount per FTE`,
         `Average Unfunded Grant`,
         `Endowment per FTE`,
         `Tuition dependence`
         ) |>
  drop_na() |>
  pivot_longer(cols = 3:8,
               names_to = 'variable') |>
  group_by(variable) |>
  mutate(rescale = scale(value)) |>
  ungroup() |>
  ggplot(aes(x = variable,
             y = `Institution Name`)) +
    geom_tile(aes(fill = rescale),
              color = 'white') +
    scale_fill_gradient(low = '#ef8a62',
                        high = 'white') +
    scale_x_discrete(expand = c(0, 0)) +
    scale_y_discrete(expand = c(0, 0)) +
    theme(legend.position = 'none',
          axis.text.x = element_text(angle = 45,
                                     hjust = 1)
          ) +
    labs(title = 'Selected Indicators',
         subtitle = 'Nebraska Institutions, FY2020-21',
         y = NULL,
         x = NULL)

```

# References

```{r}
citation('base')
citation('broom')
citation('DBI')
citation('dbplyr')
citation('knitr')
citation('lubridate')
citation('odbc')
citation('RSQLite')
citation('tidyverse')
```

Built with R version `r getRversion()`.

Packages and versions:

broom `r packageVersion('broom')`.

DBI `r packageVersion('DBI')`.

dbplyr `r packageVersion('dbplyr')`.

dplyr `r packageVersion('dplyr')`.

ggplot `r packageVersion('ggplot2')`.

lubridate `r packageVersion('lubridate')`.

odbc `r packageVersion('odbc')`.

purrr `r packageVersion('purrr')`.

RSQLite `r packageVersion('RSQLite')`.

tidyr `r packageVersion('tidyr')`.

tidyverse `r packageVersion('tidyverse')`.
