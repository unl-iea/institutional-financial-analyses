---
title: "IPEDS Financial Metrics"
author: "Jason P. Casey"
format:
  revealjs:
    self-contained: true
    footer: "[Institutional Effectiveness and Analytics](https://iea.unl.edu);"
    logo: Nebraska_N_RGB.png
    scrollable: true
    theme: custom.scss
    preview-links: auto
    slide-number: c/t
execute: 
  echo: false
editor: source
---

```{r setup}
#| label: load-packages
#| include: false
library(glue, warn.conflicts = F)
library(lubridate, warn.conflicts = F)
library(ggbeeswarm, warn.conflicts = F)
library(kableExtra, warn.conflicts = F)
library(formattable, warn.conflicts = F)
library(data.table, warn.conflicts = F)
library(tidyverse, warn.conflicts = F)

options(knitr.kable.NA = '')
options(tidyverse.quiet = TRUE)
options(dplyr.summarise.inform = FALSE)

# set random seed
set.seed(1965)


table_me <- function(df) {
  df |>
    kbl() |>
    kable_paper(c('condensed', 'hover'), full_width = F, position = 'center')
}


# include user functions
df <- readRDS('data/ipeds_summary_data.rds')

df[,
   `:=`(age = accumulated_depreciation / depreciation)]
df[depreciation <= 0 | depreciation <= 0, age := NA]

df[, recent := 0]
df[unitid %in% c(238430, 153621, 219295, 183822,
                 115728, 172440, 189848, 201751),
   closed := 1]
df[unitid %in% c(238430, 153621, 219295, 183822,
                 115728, 172440, 189848, 201751),
   recent := 1]
```

## Years Covered

::: {style="font-size: 0.65em"}
For IPEDS Survey components, fiscal years and term data (e.g., Fall Enrollment) are offset by one year in a collection cycle.  For our purposes, this offset is not much of a problem, so there has been no correction (i.e., aligning a fall term with its correct fiscal cycle).
:::

::: {style="font-size: 0.75em"}
```{r}
#| label: show-years
df |>
  distinct(Year) |>
  mutate(`Term Data` = paste0('Fall ', Year)) |>
  rename(`Collection Year` = Year) |>
  table_me()
```
:::

## First-time Enrollment

```{r}
df |>
  filter(unitid %in% c(238430, 153621, 181020)) |>
  ggplot(aes(x = Year, y = first_time_fte, group = Institution,
             color = Institution, linetype = Institution,
             shape = Institution)) +
  geom_point() +
  geom_line() +
  scale_y_continuous(labels = scales::number_format(big.mark = ",")) +
  labs(title = 'First-time Enrollment Last 10 Years',
       subtitle = 'Fall BOT',
       x = 'Fall',
       y = 'FTE')
```

## Total Enrollment

```{r}
df |>
  filter(unitid %in% c(181394, 238430, 153621, 181020)) |>
  ggplot(aes(x = Year, y = total_fte, group = Institution,
             color = Institution, linetype = Institution)) +
  geom_point() +
  geom_line() +
  scale_y_continuous(labels = scales::number_format(big.mark = ",")) +
  labs(title = 'Total Enrollment Last 10 Years',
       subtitle = 'Fall BOT',
       x = 'Fall',
       y = 'FTE')
```

## Degree-Seeking Enrollment

```{r}
df |>
  filter(unitid %in% c(181394, 238430, 153621, 181020)) |>
  mutate(ft_pct = first_time_fte / degree_seeking_fte) |>
  ggplot(aes(x = Year, y = ft_pct, group = Institution,
             color = Institution, linetype = Institution, shape = Institution)) +
  geom_point() +
  geom_line() +
  scale_y_continuous(labels = scales::percent_format()) +
  labs(title = 'First-time as a Percentage of Degree-seeking Enrollment Last 10 Years',
       subtitle = 'Fall BOT',
       x = 'Fall',
       y = 'Percentage of Degree-seeking')
```

## Deferred Mainenance

```{r}
df |>
  filter(unitid %in% c(238430, 153621, 181020, 186131, 170976, 181464)) |>
  ggplot(aes(x = `Fiscal Year`, y = age, group = Institution,
             color = Institution, linetype = Institution,
             shape = Institution)) +
  geom_point() +
  geom_line() +
  geom_hline(yintercept = 15, color = 'darkgray', linetype = 'dashed') +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1)) +
  labs(title = 'Age of Plant Last 10 Years',
       subtitle = ' Age = accumulated depreciation / annual depreciation',
       y = 'Age of Plant (years)',
       caption = 'All figures adjusted for inflation using April GDP.')
```

::: {style="font-size: 0.45em"}
For reference, I added Princeton and Michigan as Private and Public "healthy" comparators and UNL for internal interest.  Based on the limited institutional selections, there looks to be a gap between the two fallen institutions and all others in FY2012.  Their plants were 15 years old whereas all others fell around 10 years, suggesting that deferred maintenance was already a problem.  I don't know if there is anything important about the 15-year "barrier," but I've placed a reference line and you can see that Doane has crept above it.
:::

## Closed vs. Not Closed

```{r}
df[
  year_key == max(year_key) & total_fte < 2000 & !is.na(age),
  .(Institution,
    closed,
    state,
    age,
    total_fte,
    first_time_fte)][
      age >= 15 & state %in% c('SD', 'NE', 'KS', 'IA', 'MO')][
        order(-closed, Institution)
      ]
```

```{r}
df |>
  mutate(age = accumulated_depreciation / depreciation,
         Closure = factor(closed, 0:1, c('Others', 'Closure'))) |>
  filter(recent == 1 | age >= 15) |>
  filter(year_key == max(year_key)) |>
  select(institution_name, state, closed, age, total_fte, first_time_fte) |>
  arrange(-closed, institution_name)
```

## Debt

```{r}
df |>
  filter(unitid %in% c(238430, 153621, 181020)) |>
  mutate(Debt = debt / total_fte) |>
  ggplot(aes(x = `Fiscal Year`, y = Debt, group = Institution,
             color = Institution, linetype = Institution,
             shape = Institution)) +
  geom_point() +
  geom_line() +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1)) +
  scale_y_continuous(labels = scales::dollar_format(scale = 0.001,
                                                    suffix = 'K',
                                                    big.mark = ',')) +
  labs(title = 'Debt per FTE',
       subtitle = '',
       x = 'Fiscal Year Ending',
       y = 'Debt per FTE',
       caption = 'All figures adjusted for inflation using April GDP.')
```

## Unfunded Grant Aid

```{r}
df |>
  filter(unitid %in% c(238430, 153621, 181020)) |>
  mutate(igrant = unfunded_institutional_grants / total_fte) |>
  ggplot(aes(x = `Fiscal Year`, y = igrant,
             group = Institution, color = Institution, linetype = Institution,
             shape = Institution)) +
  geom_point() +
  geom_line() +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1)) +
  scale_y_continuous(labels = scales::dollar_format(scale = 0.001,
                                                    suffix = 'K',
                                                    big.mark = ',')) +
  labs(title = 'Unfunded Grant Aid per FTE',
       subtitle = '',
       x = 'Fiscal Year Ending',
       y = 'Aid per FTE',
       caption = 'All figures adjusted for inflation using April GDP.')
```

## Unfunded Institutional Aid As Percentage of Institutional Aid

```{r}
df |>
  filter(unitid %in% c(238430, 153621, 181020)) |>
  mutate(pct = unfunded_institutional_grants / (unfunded_institutional_grants +
                                                  funded_institutional_grants)) |>
  ggplot(aes(x = `Fiscal Year`, y = pct, group = Institution,
             color = Institution, linetype = Institution,
             shape = Institution)) +
  geom_point() +
  geom_line() +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1)) +
  scale_y_continuous(labels = scales::percent_format()) +
  labs(title = 'Unfunded Grants as a Percentage of Institutional Grants',
       subtitle = '',
       x = 'Fiscal Year Ending',
       y = 'Percentage')
```

::: {style="font-size: 0.45em"}
Although Iowa Wesleyan looked to have reasonable incoming enrollments compared to the others, it looks like they took on a bunch of debt in FY2017.  Without knowing much else, I'd surmise that their debt service increased financial strain during the pandemic-related downturn.
:::

## Retention Rate

```{r}
df |>
  filter(unitid %in% c(238430, 153621, 181020, 186131, 170976, 181464)) |>
  ggplot(aes(x = Year, y = ft_retention_rate, group = Institution,
             color = Institution, linetype = Institution,
             shape = Institution)) +
  geom_point() +
  geom_line() +
  scale_y_continuous(labels = scales::percent_format()) +
  labs(title = 'Retention Rate',
       subtitle = 'Fall BOT',
       x = 'Fall',
       y = 'Rate')
```

## Percentage of Student with Institutional Grants

```{r}
df |>
  filter(unitid %in% c(238430, 153621, 181020, 186131, 170976, 181464)) |>
  ggplot(aes(x = `Fiscal Year`, y = pct_inst_grant_aided, group = Institution,
             color = Institution, linetype = Institution,
             shape = Institution)) +
  geom_point() +
  geom_line() +
  scale_y_continuous(labels = scales::percent_format()) +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1)) +
  labs(title = 'Percentage of FTFT with Institutional Grants',
       subtitle = 'by Fiscal Year',
       x = 'Fiscal Year',
       y = 'Percentage')
```

## Percentage of Students With Loans
  
```{r}
df |>
  filter(unitid %in% c(238430, 153621, 181020, 186131, 170976, 181464)) |>
  ggplot(aes(x = `Fiscal Year`, y = pct_with_loans, group = Institution,
             color = Institution, linetype = Institution,
             shape = Institution)) +
  geom_point() +
  geom_line() +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1)) +
  scale_y_continuous(labels = scales::percent_format()) +
  labs(title = 'Percentage of FTFT with Loans',
       subtitle = 'by Fiscal Year',
       x = 'Fiscal Year',
       y = 'Percentage')
```

## Average Loan Amount

```{r}
df |>
  filter(unitid %in% c(238430, 153621, 181020, 186131, 170976, 181464)) |>
  ggplot(aes(x = `Fiscal Year`, y = total_loan_amount, group = Institution,
             color = Institution, linetype = Institution,
             shape = Institution)) +
  geom_point() +
  geom_line() +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1)) +
  scale_y_continuous(labels = scales::dollar_format()) +
  labs(title = 'Average Student Loan',
       subtitle = 'by Fiscal Year',
       x = 'Fiscal Year',
       y = 'Average Loan',
       caption = 'All figures adjusted for inflation using April GDP.')
```


```{r}
df_2 <- df[,
           .(unitid,
             year_key,
             total_fte,
             age = accumulated_depreciation / depreciation,
             pct = unfunded_institutional_grants /
               (unfunded_institutional_grants +
                  funded_institutional_grants),
             ft_retention_rate)]

df_2 <- df_2[is.finite(rowSums(df_2))]

scale_vars <- c('total_fte',
                'age',
                'pct',
                'ft_retention_rate')

df_2[, (scale_vars) := lapply(.SD, scale), .SDcols = scale_vars]

d <- dist(df_2[, ..scale_vars], method = 'euclidean')

fit <- hclust(d, method = 'ward')
plot(fit)
```

```{r}
# 2 cluster solution
kfit2 <- kmeans(df_2[, ..scale_vars], 2)
df_3 <- data.table(unitid = df_2$unitid,
                   year_key = df_2$year_key,
                   fit2 <- kfit2$cluster)
merge.data.table(
  x = df,
  y = df_3,
  by = c('unitid', 'year_key'),
  all.x = T) |>
  mutate(fit2 = factor(fit2, 1:2, c('cluster 1', 'cluster 2'))) |>
  ggplot()
```

