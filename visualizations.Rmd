---
title: "IPEDS Financial Metrics"
subtitle: "Visualizations"
author: "Jason P. Casey"
date: 2020-06-14
output: 
  html_notebook:
    code_folding: show
params:
  unitid:
    label: "Reference Institution"
    value: "181376"
---
                      
```{r setup}
# libraries
library(knitr)
library(hexbin)
library(WVPlots)
library(janitor)
library(lubridate)
library(tidyverse)
library(data.table)
library(RColorBrewer)

# set default document options
knitr::opts_chunk$set(fig.width = 6,
                      fig.asp = 0.618,
                      fig.retina = 2,
                      out.width = "70%",
                      fig.align = "center",
                      echo = TRUE,
                      warning = FALSE,
                      message = FALSE,
                      collapse = TRUE)

# set random seed
set.seed(1965)

# norming function
norm_it <- function(x) {
  x / first(x) * 100
}

# cutoffs
criteria <- data.table(
  Metric = c('UG First-time First Year Enrollment',
             'Retention',
             'Endowment/Expenses',
             'State Appropriations',
             'Market Price',
             'UG First-time First Year Enrollment',
             'Retention',
             'Endowment/Expenses',
             'State Appropriations',
             'Market Price'),
  Control = c(rep('Public', 5), rep('Private', 5)),
  Alert = c(-0.154, 0.68, 0, -0.27, 0, -0.174, 0.656, 0, -0.27, -0.104),
  Warning = c(-0.256, 0.62, -0.103, -0.37, -0.083, -0.308, 0.564, -0.103, -0.37, -0.175)
)
```

# Read Data

```{r}
system.time({
  metrics <- 
    fread('data/metrics.csv')[order(Unitid, year_key)][,
                              # create values normed to first year
                              `:=`(`NMarket Price` = norm_it(`Market Price`),
                                   `NUG First-time First Year Enrollment` = norm_it(`UG First-time First Year Enrollment`),
                                   `NRetention` = norm_it(`Retention`),
                                   `NState Appropriations` = norm_it(`State Appropriations`),
                                   `NEndowment/Expenses` = norm_it(`Endowment/Expenses`)),  
                              keyby = .(Unitid)]
  
  stress <-
    fread('data/stress.csv')
})
```

# Reference Institution Metric Values

```{r}
metrics[Unitid == params$unitid]
```

# Reference Institution Stess Score

```{r}
stress[Unitid == params$unitid]
```

# Plots of Reference Institution Versus Sector

## First Year Enrollment

```{r}
inst <- stress[Unitid == params$unitid, `Institution Name`, drop = TRUE]
sector <- stress[Unitid == params$unitid, Control, drop = TRUE]

ggplot(data = metrics[Control == sector],
       aes(x = `Fiscal Year`, y = `UG First-time First Year Enrollment`)) +
  # box plot for reference group
  geom_boxplot(color = '#1f78b4', fill='#a6cee3', alpha = 1/5) +
  # line plot for reference institution
  geom_line(data = metrics[Unitid == params$unitid],
            aes(x = `Fiscal Year`, y = `UG First-time First Year Enrollment`, group = 1),
            color = 'black') +
  # points for reference institution
  geom_point(data = metrics[Unitid == params$unitid],
            aes(x = `Fiscal Year`, y = `UG First-time First Year Enrollment`),
            color = 'black',
            shape = 18,
            size = 6) +
  # set y-axis to comma format
  scale_y_continuous(labels = scales::label_comma()) +
  labs(title = 'First-year Enrollment',
       subtitle = str_c(inst, 'vs.', params$control, 'Institutions', sep = ' '))
```

## Retention

```{r}
ggplot(data = metrics[Control == sector],
       aes(x = `Fiscal Year`, y = Retention)) +
  # box plot for reference group
  geom_boxplot(color = '#1f78b4', fill='#a6cee3', alpha = 1/5) +
  # line plot for reference institution
  geom_line(data = metrics[Unitid == params$unitid],
            aes(x = `Fiscal Year`, y = Retention, group = 1),
            color = 'black') +
  # points for reference institution
  geom_point(data = metrics[Unitid == params$unitid],
            aes(x = `Fiscal Year`, y = Retention),
            color = 'black',
            shape = 18,
            size = 6) +
  # set y-axis to percentage format
  scale_y_continuous(labels = scales::label_percent()) +
  labs(title = 'Retention',
       subtitle = str_c(inst, 'vs.', params$control, 'Institutions', sep = ' '))
```

## Market Price

```{r}
ggplot(data = metrics[Control == sector],
       aes(x = `Fiscal Year`, y = `Market Price`)) +
  # box plot for reference group
  geom_boxplot(color = '#1f78b4', fill='#a6cee3', alpha = 1/5) +
  # line plot for reference institution
  geom_line(data = metrics[Unitid == params$unitid],
            aes(x = `Fiscal Year`, y = `Market Price`, group = 1),
            color = 'black') +
  # points for reference institution
  geom_point(data = metrics[Unitid == params$unitid],
            aes(x = `Fiscal Year`, y = `Market Price`),
            color = 'black',
            shape = 18,
            size = 6) +
  # set y-axis to dollar format
  scale_y_continuous(labels = scales::label_dollar()) +
  labs(title = 'Market Price',
       subtitle = str_c(inst, 'vs.', params$control, 'Institutions', sep = ' '),
       caption = 'Dollars adjusted for inflation using GDP.')
```

## Endowment/Expenses (Privates) or State Appropriations (Publics)

```{r}
if (sector == 'Public') {
  ggplot(data = metrics[Control == sector],
         aes(x = `Fiscal Year`, y = `State Appropriations`)) +
    # box plot for reference group
    geom_boxplot(color = '#1f78b4', fill='#a6cee3', alpha = 1/5) +
    # line plot for reference institution
    geom_line(data = metrics[Unitid == params$unitid],
              aes(x = `Fiscal Year`, y = `State Appropriations`, group = 1),
              color = 'black') +
    # points for reference institution
    geom_point(data = metrics[Unitid == params$unitid],
              aes(x = `Fiscal Year`, y = `State Appropriations`),
              color = 'black',
              shape = 18,
              size = 6) +
    # set y-axis to dollar format
    scale_y_continuous(labels = scales::label_dollar()) +
  labs(title = 'State Appropriations',
       subtitle = str_c(inst, 'vs.', params$control, 'Institutions', sep = ' '))
} else {
  ggplot(data = metrics[Control == sector],
         aes(x = `Fiscal Year`, y = `Endowment/Expenses`)) +
    # box plot for reference group
    geom_boxplot(color = '#1f78b4', fill='#a6cee3', alpha = 1/5) +
    # line plot for reference institution
    geom_line(data = metrics[Unitid == params$unitid],
              aes(x = `Fiscal Year`, y = `Endowment/Expenses`, group = 1),
              color = 'black') +
    # points for reference institution
    geom_point(data = metrics[Unitid == params$unitid],
              aes(x = `Fiscal Year`, y = `Endowment/Expenses`),
              color = 'black',
              shape = 18,
              size = 6) +
    # set y-axis to dollar format
    scale_y_continuous(labels = scales::label_dollar()) +
  labs(title = 'Endowment to Total Expenses less Hospital Expenses',
       subtitle = str_c(inst, 'vs.', params$control, 'Institutions', sep = ' '))
}
```

# Plot of Normed Metrics

```{r out.width = "70%"}
ggplot(data = metrics[Unitid == params$unitid],
       aes(x = `Fiscal Year`, group = 1)) +
  geom_line(aes(y = `NMarket Price`, color = 'Market Price'), size = 1) +
  geom_line(aes(y = `NUG First-time First Year Enrollment`, color = 'FY Enrollment'), size = 1) +
  geom_line(aes(y = `NRetention`, color = 'Retention'), size = 1) +
  geom_line(aes(y = `NState Appropriations`, color = 'Appropriations'), size = 1) +
  labs(title = str_c('Scaled Metrics for', inst, sep = ' '),
       subtitle = str_c(min(metrics$`Fiscal Year`), max(metrics$`Fiscal Year`), sep = ' through '),
       caption = 'Scaled to First Year = 100',
       color = 'Metric') +
  scale_colour_brewer(palette = 'Set2')
```

# Plots of Institutional Metrics

## First Year Enrollment

```{r}
inst_val <- metrics[Unitid == params$unitid][order(year_key)][, .(ref = first(`UG First-time First Year Enrollment`))]
alert_line <- criteria[Control == sector & Metric == 'UG First-time First Year Enrollment', .(Alert = (1 + Alert) * inst_val$ref)]
warn_line <- criteria[Control == sector & Metric == 'UG First-time First Year Enrollment', .(Warning = (1 + Warning) * inst_val$ref)]

df <- data.table(year_key = seq(max(metrics$year_key) + 1,
                                max(metrics$year_key) + 3))[,
                                                            `:=`(`Fiscal Year` = str_c(year_key - 1, year_key, sep='-'),
                                                                 Unitid = as.integer(params$unitid))] %>%
  bind_rows(., metrics[Unitid == params$unitid])

fit <- lm(`UG First-time First Year Enrollment` ~ year_key, data = df)
df$pred <- predict(fit, df)
  
ggplot(data = df,
       aes(x = `Fiscal Year`, y = `UG First-time First Year Enrollment`, group = 1)) +
  geom_line(size = 1) +
  geom_line(aes(y = pred),
            linetype = 'longdash',
            color = '#7570b3') +
  geom_hline(data = alert_line,
             aes(yintercept = Alert), linetype = 'dashed', color = '#1b9e77') +
  geom_hline(data = warn_line,
             aes(yintercept = Warning), linetype = 'dashed', color = '#d95f02') +
  # set y-axis to comma format
  scale_y_continuous(labels = scales::label_comma()) +
  labs(title = 'First-year Enrollment',
       subtitle = inst)
```

## Retention

```{r}
alert_line <- criteria[Control == sector & Metric == 'Retention', .(Alert)]
warn_line <- criteria[Control == sector & Metric == 'Retention', .(Warning)]

df <- data.table(year_key = seq(max(metrics$year_key) + 1,
                                max(metrics$year_key) + 3))[,
                                                            `:=`(`Fiscal Year` = str_c(year_key - 1, year_key, sep='-'),
                                                                 Unitid = as.integer(params$unitid))] %>%
  bind_rows(., metrics[Unitid == params$unitid])

fit <- lm(Retention ~ year_key, data = df)
df$pred <- predict(fit, df)
  
ggplot(data = df,
       aes(x = `Fiscal Year`, y = Retention, group = 1)) +
  geom_line(size = 1) +
  geom_line(aes(y = pred),
            linetype = 'longdash',
            color = '#7570b3') +
  geom_hline(data = alert_line,
             aes(yintercept = Alert), linetype = 'dashed', color = '#1b9e77') +
  geom_hline(data = warn_line,
             aes(yintercept = Warning), linetype = 'dashed', color = '#d95f02') +
  # set y-axis to percent format
  scale_y_continuous(labels = scales::label_percent()) +
  labs(title = 'Retention',
       subtitle = inst)
```

## Market Price

```{r}
inst_val <- metrics[Unitid == params$unitid][order(year_key)][, .(ref = first(`Market Price`))]
alert_line <- criteria[Control == sector & Metric == 'Market Price', .(Alert = (1 + Alert) * inst_val$ref)]
warn_line <- criteria[Control == sector & Metric == 'Market Price', .(Warning = (1 + Warning) * inst_val$ref)]

df <- data.table(year_key = seq(max(metrics$year_key) + 1,
                                max(metrics$year_key) + 3))[,
                                                            `:=`(`Fiscal Year` = str_c(year_key - 1, year_key, sep='-'),
                                                                 Unitid = as.integer(params$unitid))] %>%
  bind_rows(., metrics[Unitid == params$unitid])

fit <- lm(`Market Price` ~ year_key, data = df)
df$pred <- predict(fit, df)
  
ggplot(data = df,
       aes(x = `Fiscal Year`, y = `Market Price`, group = 1)) +
  geom_line(size = 1) +
  geom_line(aes(y = pred),
            linetype = 'longdash',
            color = '#7570b3') +
  geom_hline(data = alert_line,
             aes(yintercept = Alert), linetype = 'dashed', color = '#1b9e77') +
  geom_hline(data = warn_line,
             aes(yintercept = Warning), linetype = 'dashed', color = '#d95f02') +
  # set y-axis to dollar format
  scale_y_continuous(labels = scales::label_dollar()) +
  labs(title = 'Market Price',
       subtitle = inst)
```

## Endowment/Expenses (Privates) or State Appropriations (Publics)

```{r}
if (sector == 'Public') {
  inst_val <- metrics[Unitid == params$unitid][order(year_key)][, .(ref = first(`State Appropriations`))]
  alert_line <- criteria[Control == sector & Metric == 'State Appropriations', .(Alert = (1 + Alert) * inst_val$ref)]
  warn_line <- criteria[Control == sector & Metric == 'State Appropriations', .(Warning = (1 + Warning) * inst_val$ref)]
  
  df <- data.table(year_key = seq(max(metrics$year_key) + 1,
                                  max(metrics$year_key) + 3))[,
                                                              `:=`(`Fiscal Year` = str_c(year_key - 1, year_key, sep='-'),
                                                                   Unitid = as.integer(params$unitid))] %>%
    bind_rows(., metrics[Unitid == params$unitid])
  
  fit <- lm(`State Appropriations` ~ year_key, data = df)
  df$pred <- predict(fit, df)
    
  ggplot(data = df,
         aes(x = `Fiscal Year`, y = `State Appropriations`, group = 1)) +
    geom_line(size = 1) +
    geom_line(aes(y = pred),
              linetype = 'longdash',
              color = '#7570b3') +
    geom_hline(data = alert_line,
               aes(yintercept = Alert), linetype = 'dashed', color = '#1b9e77') +
    geom_hline(data = warn_line,
               aes(yintercept = Warning), linetype = 'dashed', color = '#d95f02') +
    # set y-axis to dollar format
    scale_y_continuous(labels = scales::label_dollar()) +
    labs(title = 'State Apprpriations',
         subtitle = inst)
} else {
  inst_val <- metrics[Unitid == params$unitid][order(year_key)][, .(ref = first(`Endowment/Expenses`))]
  alert_line <- criteria[Control == sector & Metric == 'Endowment/Expenses', .(Alert = (1 + Alert) * inst_val$ref)]
  warn_line <- criteria[Control == sector & Metric == 'Endowment/Expenses', .(Warning = (1 + Warning) * inst_val$ref)]
  
  df <- data.table(year_key = seq(max(metrics$year_key) + 1,
                                  max(metrics$year_key) + 3))[,
                                                              `:=`(`Fiscal Year` = str_c(year_key - 1, year_key, sep='-'),
                                                                   Unitid = as.integer(params$unitid))] %>%
    bind_rows(., metrics[Unitid == params$unitid])
  
  fit <- lm(`Endowment/Expenses` ~ year_key, data = df)
  df$pred <- predict(fit, df)
    
  ggplot(data = df,
         aes(x = `Fiscal Year`, y = `Endowment/Expenses`, group = 1)) +
    geom_line(size = 1) +
    geom_line(aes(y = pred),
              linetype = 'longdash',
              color = '#7570b3') +
    geom_hline(data = alert_line,
               aes(yintercept = Alert), linetype = 'dashed', color = '#1b9e77') +
    # geom_label(data = alert_line, aes(mapping = 'Alert', y = Alert)) +
    geom_hline(data = warn_line,
               aes(yintercept = Warning), linetype = 'dashed', color = '#d95f02') +
    # set y-axis to comma format
    scale_y_continuous(labels = scales::label_comma(scale = 2)) +
    labs(title = 'Endowment/Expenses',
         subtitle = inst)
}
```

# Other Useful Stuff

## Color Palette

Use the following to select the color palette if you have difficulty with the defaults

### Palette Names

```{r}
brewer.pal.info
```

### Color Brewer Qualitative (Categorical) Palettes

```{r}
display.brewer.all(n=NULL, type="qual", select=NULL, exact.n=TRUE, 
colorblindFriendly=FALSE)
```
